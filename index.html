<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tirage au sort Americano Manon vs Lisa</title>

  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 16px; background:#fafafa; }
    .wrap { max-width: 920px; margin: 0 auto; }
    .banner { width:100%; border-radius:14px; overflow:hidden; border:1px solid #e8e8e8; background:#fff; }
    .banner img { width:100%; height:auto; display:block; }
    h1 { margin: 12px 0 6px; line-height:1.1; }
    .muted { color: #666; }
    .card { background:#fff; border: 1px solid #e8e8e8; border-radius: 14px; padding: 14px; margin: 12px 0; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    button { padding: 12px 14px; border-radius: 12px; border: 1px solid #ccc; background: white; cursor: pointer; font-weight: 700; }
    button.primary { border-color: #111; }
    button.danger { border-color: #a40000; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pill { display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#fff; }
    code { background:#f2f2f2; padding:2px 6px; border-radius:8px; }
    a { word-break: break-all; }
    hr { border:none; border-top:1px solid #eee; margin:12px 0; }
    .big { font-size: 18px; font-weight: 900; }
    .score { font-size: 16px; font-weight: 900; }
    .ok { color:#0a7a2f; font-weight:800; }
    .warn { color:#a15b00; font-weight:800; }
    ul { margin:8px 0 0 18px; }
    .panelTitle { font-weight: 900; margin-bottom: 6px; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- ‚úÖ BANDEAU -->
  <div class="banner">
    <img src="banner.jpeg" alt="Lisa vs Manon - Americano" />
  </div>

  <h1>üé≤ Tirage au sort Americano</h1>
  <div class="muted">Pierre ‚úä / Feuille ‚úã / Ciseaux ‚úåÔ∏è ‚Äî premier √† <b>5</b> gagne.</div>

  <div class="card" id="setupCard">
    <div class="big">Cr√©er / rejoindre une partie</div>
    <p class="muted">
      Partage le lien <b>Spectateur</b> √† la communaut√©.
      Garde les liens <b>Lisa</b> et <b>Manon</b> priv√©s.
    </p>
    <div class="row">
      <button class="primary" id="btnCreate">Cr√©er une nouvelle partie</button>
      <button id="btnJoin">Rejoindre une partie existante</button>
    </div>
    <div id="joinRow" style="display:none; margin-top:10px;">
      <input id="gameIdInput" placeholder="Game ID (ex: -Nabc123...)" style="padding:10px; border-radius:12px; border:1px solid #ccc; width: 360px; max-width:100%;" />
      <button id="btnGo">Go</button>
    </div>
    <div id="links" style="margin-top:12px;"></div>
  </div>

  <div class="card" id="gameCard" style="display:none;">
    <div class="row" style="justify-content: space-between;">
      <div class="row">
        <span class="pill" id="rolePill">‚Äî</span>
        <span class="pill">Game ID: <code id="gameIdLabel"></code></span>
        <span class="pill" id="autoPill">‚Äî</span>
      </div>
      <div class="score" id="scoreLine">‚Äî</div>
    </div>

    <hr />

    <div class="big" id="statusLine">‚Äî</div>
    <div class="muted" id="subStatus">‚Äî</div>

    <div id="controls" style="margin-top:12px; display:none;">
      <div class="row">
        <button id="btnRock">‚úä Pierre</button>
        <button id="btnPaper">‚úã Feuille</button>
        <button id="btnScissors">‚úåÔ∏è Ciseaux</button>
      </div>
      <div class="muted" style="margin-top:8px;">Ton choix reste cach√© jusqu‚Äô√† ce que l‚Äôautre joueur ait jou√©.</div>
    </div>

    <div id="resultBox" style="margin-top:14px;"></div>

    <div class="row" style="margin-top:12px;">
      <button id="btnResume" style="display:none;">‚ñ∂Ô∏è Reprendre (3 manches)</button>
      <button id="btnReset" class="danger" style="display:none;">Revanche (reset)</button>
    </div>

    <!-- ‚úÖ Fin de partie : choix du vainqueur -->
    <div class="card" id="winnerChoiceCard" style="display:none;">
      <div class="panelTitle">üèÅ Choix du vainqueur</div>
      <div class="muted" id="winnerChoiceInfo"></div>
      <div class="row" id="winnerChoiceButtons" style="margin-top:10px; display:none;">
        <button id="btnChooseFirstPlayer">Choix du premier joueur</button>
        <button id="btnChooseColor">Choix de la couleur</button>
      </div>
      <div class="row" id="colorButtons" style="margin-top:10px; display:none;">
        <button id="btnRed">Rouge</button>
        <button id="btnYellow">Jaune</button>
      </div>
    </div>

    <div class="card" id="historyCard" style="display:none;">
      <div class="big">üìú Historique (partie en cours)</div>
      <div class="muted">Derni√®res manches (les plus r√©centes en haut)</div>
      <div id="historyList" style="margin-top:8px;"></div>
    </div>

    <div class="muted" style="margin-top:10px;">
      Astuce : partage uniquement le lien <b>Spectateur</b> au groupe.
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, set, update, onValue, push, limitToLast, query } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCcTl2H__r_8oRZ7VF4iDHtF2jO0idKW0k",
    authDomain: "tirage-americano-manon-vs-lisa.firebaseapp.com",
    databaseURL: "https://tirage-americano-manon-vs-lisa-default-rtdb.firebaseio.com",
    projectId: "tirage-americano-manon-vs-lisa",
    storageBucket: "tirage-americano-manon-vs-lisa.appspot.com",
    messagingSenderId: "468030106920",
    appId: "1:468030106920:web:606f8fb66275c90936b41d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // --- Helpers
  const qs = new URLSearchParams(location.search);
  const roleParam = qs.get("role");          // admin | player1 | player2 | spectator
  const gameIdFromUrl = qs.get("game");      // firebase push key
  const keyFromUrl = qs.get("k");            // secret key

  const LABEL = { ROCK:"‚úä Pierre", PAPER:"‚úã Feuille", SCISSORS:"‚úåÔ∏è Ciseaux" };

  function outcome(p1, p2) {
    if (!p1 || !p2) return null;
    if (p1 === p2) return "DRAW";
    if (
      (p1==="ROCK" && p2==="SCISSORS") ||
      (p1==="PAPER" && p2==="ROCK") ||
      (p1==="SCISSORS" && p2==="PAPER")
    ) return "P1";
    return "P2";
  }

  function roleName(r){
    if (r==="admin") return "Admin";
    if (r==="player1") return "Lisa";
    if (r==="player2") return "Manon";
    if (r==="spectator") return "Spectateur";
    return "‚Äî";
  }

  function genKey() {
    const a = new Uint8Array(16);
    crypto.getRandomValues(a);
    return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function winnerRoleFromName(name){
    if (name === "Lisa") return "player1";
    if (name === "Manon") return "player2";
    return null;
  }

  // --- UI
  const setupCard = document.getElementById("setupCard");
  const gameCard = document.getElementById("gameCard");
  const linksBox = document.getElementById("links");
  const joinRow = document.getElementById("joinRow");
  const gameIdInput = document.getElementById("gameIdInput");

  const rolePill = document.getElementById("rolePill");
  const autoPill = document.getElementById("autoPill");
  const gameIdLabel = document.getElementById("gameIdLabel");
  const statusLine = document.getElementById("statusLine");
  const subStatus = document.getElementById("subStatus");
  const scoreLine = document.getElementById("scoreLine");
  const controls = document.getElementById("controls");
  const resultBox = document.getElementById("resultBox");

  const btnResume = document.getElementById("btnResume");
  const btnReset = document.getElementById("btnReset");

  const btnRock = document.getElementById("btnRock");
  const btnPaper = document.getElementById("btnPaper");
  const btnScissors = document.getElementById("btnScissors");

  const historyCard = document.getElementById("historyCard");
  const historyList = document.getElementById("historyList");

  // Winner flow UI
  const winnerChoiceCard = document.getElementById("winnerChoiceCard");
  const winnerChoiceInfo = document.getElementById("winnerChoiceInfo");
  const winnerChoiceButtons = document.getElementById("winnerChoiceButtons");
  const colorButtons = document.getElementById("colorButtons");
  const btnChooseFirstPlayer = document.getElementById("btnChooseFirstPlayer");
  const btnChooseColor = document.getElementById("btnChooseColor");
  const btnRed = document.getElementById("btnRed");
  const btnYellow = document.getElementById("btnYellow");

  // --- Create / Join
  document.getElementById("btnCreate").onclick = async () => {
    const newGameRef = push(ref(db, "games"));
    const gid = newGameRef.key;

    const adminKey = genKey();
    const p1Key = genKey();
    const p2Key = genKey();

    await set(newGameRef, {
      title: "Tirage au sort Americano Manon vs Lisa",
      createdAt: Date.now(),
      round: 1,
      target: 5,
      status: "WAITING", // WAITING | PAUSE | FINISHED
      players: { p1Name: "Lisa", p2Name: "Manon" },
      keys: { admin: adminKey, p1: p1Key, p2: p2Key },
      choices: { p1: null, p2: null },
      scores: { p1: 0, p2: 0 },
      lastResult: null,
      winner: null,
      auto: { enabled: true, batchSize: 3, remaining: 3 },
      postGame: { stage: "NONE", decisionType: null, color: null }
    });

    const base = location.origin + location.pathname;
    const lAdmin = `${base}?game=${gid}&role=admin&k=${adminKey}`;
    const l1 = `${base}?game=${gid}&role=player1&k=${p1Key}`;
    const l2 = `${base}?game=${gid}&role=player2&k=${p2Key}`;
    const ls = `${base}?game=${gid}&role=spectator`;

    linksBox.innerHTML = `
      <div class="card">
        <div class="big">‚úÖ Liens pr√™ts</div>
        <p><b>Admin</b> : <a href="${lAdmin}">${lAdmin}</a></p>
        <p><b>Lisa</b> : <a href="${l1}">${l1}</a></p>
        <p><b>Manon</b> : <a href="${l2}">${l2}</a></p>
        <p><b>Spectateur</b> (√† partager) : <a href="${ls}">${ls}</a></p>
        <p class="muted"><span class="warn">‚ö†Ô∏è</span> Ne partage pas les liens Admin/Lisa/Manon au groupe.</p>
      </div>
    `;
  };

  document.getElementById("btnJoin").onclick = () => {
    joinRow.style.display = joinRow.style.display === "none" ? "block" : "none";
  };
  document.getElementById("btnGo").onclick = () => {
    const gid = gameIdInput.value.trim();
    if (!gid) return;
    const base = location.origin + location.pathname;
    location.href = `${base}?game=${encodeURIComponent(gid)}&role=spectator`;
  };

  // --- If opened with game & role
  if (gameIdFromUrl && roleParam) {
    setupCard.style.display = "none";
    gameCard.style.display = "block";
    gameIdLabel.textContent = gameIdFromUrl;

    const gameRef = ref(db, `games/${gameIdFromUrl}`);
    const histRef = ref(db, `games/${gameIdFromUrl}/history`);

    let canAdmin = false;
    let canP1 = false;
    let canP2 = false;

    function computePerms(st){
      const keys = st?.keys || {};
      canAdmin = (roleParam==="admin" && keyFromUrl && keyFromUrl === keys.admin);
      canP1 = (roleParam==="player1" && keyFromUrl && keyFromUrl === keys.p1);
      canP2 = (roleParam==="player2" && keyFromUrl && keyFromUrl === keys.p2);

      const uiRole = (canAdmin ? "admin" : canP1 ? "player1" : canP2 ? "player2" : "spectator");
      rolePill.textContent = roleName(uiRole);
      return uiRole;
    }

    function setControlsVisible(uiRole){
      const canPlay = (uiRole==="player1" || uiRole==="player2");
      controls.style.display = canPlay ? "block" : "none";
    }

    async function choose(choice, uiRole, st) {
      if (uiRole !== "player1" && uiRole !== "player2") return;
      if (st?.status === "PAUSE" || st?.winner) return;
      const path = uiRole === "player1" ? "choices/p1" : "choices/p2";
      await update(gameRef, { [path]: choice });
    }

    btnRock.onclick = () => choose("ROCK", window.__uiRole, window.__state);
    btnPaper.onclick = () => choose("PAPER", window.__uiRole, window.__state);
    btnScissors.onclick = () => choose("SCISSORS", window.__uiRole, window.__state);

    // ‚úÖ Reprendre : on repart sur un NOUVEAU tour (donc d√©verrouille Lisa/Manon)
    btnResume.onclick = async () => {
      if (!canAdmin) return;
      const st = window.__state;
      if (!st || st.winner) return;

      await update(gameRef, {
        auto: { enabled: true, batchSize: 3, remaining: 3 },
        status: "WAITING",
        round: (st.round || 1) + 1,
        choices: { p1: null, p2: null },
        lastResult: null
      });
    };

    // ‚úÖ Reset : on remet tout + on vide l'historique (partie en cours uniquement)
    btnReset.onclick = async () => {
      if (!canAdmin) return;

      await update(gameRef, {
        round: 1,
        status: "WAITING",
        choices: { p1: null, p2: null },
        scores: { p1: 0, p2: 0 },
        lastResult: null,
        winner: null,
        auto: { enabled: true, batchSize: 3, remaining: 3 },
        postGame: { stage: "NONE", decisionType: null, color: null }
      });

      // vider l'historique
      await set(histRef, null);
    };

    // ‚úÖ Historique (D) - uniquement partie en cours
    onValue(query(histRef, limitToLast(50)), (snap) => {
      const obj = snap.val();
      if (!obj) {
        historyCard.style.display = "none";
        historyList.innerHTML = "";
        return;
      }
      const items = Object.values(obj).sort((a,b)=>(b.at||0)-(a.at||0));
      historyCard.style.display = "block";
      historyList.innerHTML = `<ul>${items.map(it => {
        const resTxt = it.res==="DRAW" ? "√âgalit√©" : (it.res==="P1" ? "Lisa gagne" : "Manon gagne");
        return `<li><b>Tour ${it.round}</b> ‚Äî Lisa: ${LABEL[it.p1]} / Manon: ${LABEL[it.p2]} ‚Üí <b>${resTxt}</b></li>`;
      }).join("")}</ul>`;
    });

    // ‚úÖ PostGame actions (vainqueur)
    async function setWinnerDecision(decisionType, color=null){
      const st = window.__state;
      if (!st || !st.winner) return;

      const winnerRole = winnerRoleFromName(st.winner);
      if (window.__uiRole !== winnerRole) return; // seul le vainqueur

      if (decisionType === "FIRST_PLAYER") {
        await update(gameRef, {
          postGame: { stage: "DONE", decisionType: "FIRST_PLAYER", color: null }
        });
      } else if (decisionType === "COLOR") {
        if (color) {
          await update(gameRef, {
            postGame: { stage: "DONE", decisionType: "COLOR", color }
          });
        } else {
          await update(gameRef, {
            postGame: { stage: "COLOR_CHOICE", decisionType: "COLOR", color: null }
          });
        }
      }
    }

    btnChooseFirstPlayer.onclick = () => setWinnerDecision("FIRST_PLAYER");
    btnChooseColor.onclick = () => setWinnerDecision("COLOR");
    btnRed.onclick = () => setWinnerDecision("COLOR", "ROUGE");
    btnYellow.onclick = () => setWinnerDecision("COLOR", "JAUNE");

    // Live updates (jeu)
    onValue(gameRef, async (snap) => {
      const st = snap.val();
      window.__state = st;

      if (!st) {
        statusLine.textContent = "Partie introuvable.";
        subStatus.textContent = "V√©rifie le Game ID.";
        controls.style.display = "none";
        return;
      }

      window.__uiRole = computePerms(st);
      setControlsVisible(window.__uiRole);

      const s1 = st.scores?.p1 ?? 0;
      const s2 = st.scores?.p2 ?? 0;
      scoreLine.textContent = `Score ‚Äî Lisa: ${s1} | Manon: ${s2}`;

      const remaining = st.auto?.remaining ?? 0;
      const status = st.status || "WAITING";
      autoPill.textContent =
        status === "PAUSE"
          ? `‚è∏ Pause (admin)`
          : (st.winner ? `üèÅ Termin√©` : `‚ö° Auto: ${remaining}/3`);

      const p1 = st.choices?.p1;
      const p2 = st.choices?.p2;

      // ‚úÖ Lisa voit si Manon a jou√© (et inversement)
      const otherPlayedForP1 = p2 ? "‚úÖ Manon a jou√©" : "‚Ä¶ Manon n'a pas encore jou√©";
      const otherPlayedForP2 = p1 ? "‚úÖ Lisa a jou√©" : "‚Ä¶ Lisa n'a pas encore jou√©";

      // D√©sactiver choix si d√©j√† jou√© / pause / fin
      const myChoice = (window.__uiRole==="player1") ? p1 : (window.__uiRole==="player2") ? p2 : null;
      const disableChoices =
        !(window.__uiRole==="player1" || window.__uiRole==="player2") ||
        !!myChoice ||
        st.winner ||
        status === "PAUSE";

      [btnRock, btnPaper, btnScissors].forEach(b => b.disabled = disableChoices);

      const bothPlayed = !!p1 && !!p2;
      const finished = !!st.winner;

      // Boutons admin
      btnReset.style.display = canAdmin ? "inline-block" : "none";
      btnResume.style.display = (canAdmin && status === "PAUSE" && !finished) ? "inline-block" : "none";

      // Auto-resolve once
      if (bothPlayed && !st.lastResult && !finished) {
        const res = outcome(p1, p2);
        let ns1 = s1, ns2 = s2;
        if (res === "P1") ns1++;
        if (res === "P2") ns2++;

        let winner = null;
        if (ns1 >= (st.target || 5)) winner = "Lisa";
        if (ns2 >= (st.target || 5)) winner = "Manon";

        const lr = {
          at: Date.now(),
          round: st.round,
          p1, p2, res,
          text: res==="DRAW" ? "√âgalit√©" : (res==="P1" ? "Lisa gagne la manche" : "Manon gagne la manche")
        };

        const curRemaining = (st.auto?.remaining ?? 1);
        const nextRemaining = Math.max(0, curRemaining - 1);

        const nextStatus = winner
          ? "FINISHED"
          : (nextRemaining > 0 ? "WAITING" : "PAUSE");

        await update(gameRef, {
          lastResult: lr,
          scores: { p1: ns1, p2: ns2 },
          status: nextStatus,
          winner: winner,
          auto: { enabled: true, batchSize: 3, remaining: winner ? 0 : nextRemaining },
          postGame: winner ? { stage: "WINNER_CHOICE", decisionType: null, color: null } : (st.postGame || { stage: "NONE", decisionType: null, color: null })
        });

        // ‚úÖ Historique UNE SEULE FOIS PAR TOUR
        const histOnceRef = ref(db, `games/${gameIdFromUrl}/history/${st.round}`);
        await set(histOnceRef, lr);

        // ‚úÖ Auto-advance (dans le batch)
        if (!winner && nextRemaining > 0) {
          setTimeout(async () => {
            await update(gameRef, {
              round: st.round + 1,
              choices: { p1: null, p2: null },
              lastResult: null
            });
          }, 900);
        }
        return;
      }

      // UI states
      if (finished) {
        statusLine.textContent = `üèÜ ${st.winner} a gagn√© !`;
        subStatus.textContent = "Fin de partie.";

      } else if (status === "PAUSE") {
        statusLine.textContent = `‚è∏ Pause apr√®s 3 manches`;
        subStatus.textContent = canAdmin
          ? "Admin : clique sur ‚ÄúReprendre (3 manches)‚Äù pour relancer."
          : "En attente que l‚Äôadmin relance‚Ä¶";

      } else if (bothPlayed && st.lastResult) {
        statusLine.textContent = `R√©sultat du tour ${st.round}`;
        subStatus.textContent = st.lastResult.text;

      } else {
        statusLine.textContent = `Tour ${st.round} en cours‚Ä¶`;
        if (window.__uiRole==="player1") {
          if (myChoice) subStatus.innerHTML = "<span class='ok'>‚úÖ Choix enregistr√©.</span> En attente de Manon‚Ä¶";
          else subStatus.textContent = "Choisis ‚úä ‚úã ‚úåÔ∏è (ton choix est cach√©).";
          subStatus.innerHTML += `<br><span class="muted">${otherPlayedForP1}</span>`;
        } else if (window.__uiRole==="player2") {
          if (myChoice) subStatus.innerHTML = "<span class='ok'>‚úÖ Choix enregistr√©.</span> En attente de Lisa‚Ä¶";
          else subStatus.textContent = "Choisis ‚úä ‚úã ‚úåÔ∏è (ton choix est cach√©).";
          subStatus.innerHTML += `<br><span class="muted">${otherPlayedForP2}</span>`;
        } else {
          subStatus.textContent = `En attente des joueurs‚Ä¶ (${p1 ? "Lisa ‚úÖ" : "Lisa ‚Ä¶"} / ${p2 ? "Manon ‚úÖ" : "Manon ‚Ä¶"})`;
        }
      }

      // R√©v√©lation
      if (st.lastResult) {
        const lr = st.lastResult;
        resultBox.innerHTML = `
          <div class="card">
            <div class="big">üé¨ R√©v√©lation</div>
            <div><b>Lisa</b> : <b>${LABEL[lr.p1]}</b></div>
            <div><b>Manon</b> : <b>${LABEL[lr.p2]}</b></div>
            <div style="margin-top:8px;"><b>${lr.text}</b></div>
          </div>
        `;
      } else {
        resultBox.innerHTML = "";
      }

      // ‚úÖ Affichage post-game (vainqueur + suivi perdant/spectateurs en temps r√©el)
      const pg = st.postGame || { stage:"NONE", decisionType:null, color:null };
      if (st.winner) {
        winnerChoiceCard.style.display = "block";

        const winnerRole = winnerRoleFromName(st.winner);
        const isWinner = (window.__uiRole === winnerRole);

        if (pg.stage === "WINNER_CHOICE") {
          winnerChoiceInfo.textContent = isWinner
            ? "Tu as gagn√© : choisis ce que tu veux d√©cider."
            : `${st.winner} doit choisir : ‚Äúpremier joueur‚Äù ou ‚Äúcouleur‚Äù.`;
          winnerChoiceButtons.style.display = isWinner ? "flex" : "none";
          colorButtons.style.display = "none";

        } else if (pg.stage === "COLOR_CHOICE") {
          winnerChoiceInfo.textContent = isWinner
            ? "Tu as choisi : couleur. Choisis Rouge ou Jaune."
            : `${st.winner} doit choisir la couleur (Rouge/Jaune).`;
          winnerChoiceButtons.style.display = "none";
          colorButtons.style.display = isWinner ? "flex" : "none";

        } else if (pg.stage === "DONE") {
          if (pg.decisionType === "FIRST_PLAYER") {
            winnerChoiceInfo.textContent = `D√©cision finale : ‚úÖ ${st.winner} a choisi ‚ÄúChoix du premier joueur‚Äù.`;
          } else if (pg.decisionType === "COLOR") {
            winnerChoiceInfo.textContent = `D√©cision finale : ‚úÖ ${st.winner} a choisi la couleur : ${pg.color}.`;
          } else {
            winnerChoiceInfo.textContent = `D√©cision finale enregistr√©e.`;
          }
          winnerChoiceButtons.style.display = "none";
          colorButtons.style.display = "none";
        } else {
          // fallback
          winnerChoiceInfo.textContent = "D√©cision en attente‚Ä¶";
          winnerChoiceButtons.style.display = "none";
          colorButtons.style.display = "none";
        }
      } else {
        winnerChoiceCard.style.display = "none";
      }
    });
  }
</script>
</body>
</html>
